<div class="gantt-container" (wheel)="onWheel($event)">

    <!-- Gear Icon for Editor -->
    <div class="settings-gear" (mouseenter)="onGearMouseEnter()">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path
                d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z">
            </path>
            <circle cx="12" cy="12" r="3"></circle>
        </svg>
    </div>

    <!-- Floating Toolbar (Green Gear) -->
    <div class="gantt-toolbar-wrapper" [style.left.px]="taskListWidth() + 20">
        <!-- Back Button -->
        <div class="toolbar-trigger" (click)="goBack()" style="margin-right: 10px;" title="Back to Projects">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M19 12H5"></path>
                <path d="M12 19l-7-7 7-7"></path>
            </svg>
        </div>

        <!-- Gear Icon for Toolbar -->
        <div class="toolbar-trigger" (click)="toggleToolbar($event)">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="gear-icon">
                <path
                    d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z">
                </path>
                <circle cx="12" cy="12" r="3"></circle>
            </svg>
        </div>

        <!-- Columns Toggle Button -->
        <div class="toolbar-trigger" (click)="toggleColumnDropdown($event)" style="margin-left: 10px;">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M9 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h4"></path>
                <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path>
                <path d="M9 3v18"></path>
                <path d="M15 3v18"></path>
            </svg>
        </div>

        <!-- Columns Dropdown -->
        <div class="toolbar-dropdown columns-dropdown" [class.visible]="isColumnDropdownOpen"
            (click)="$event.stopPropagation()" style="left: 60px; min-width: 200px;">
            <div class="dropdown-header" style="padding: 8px; font-weight: bold; border-bottom: 1px solid #eee;">
                Visible Columns
            </div>
            <div class="dropdown-item" *ngFor="let col of columns()" (click)="toggleColumn(col.id)"
                style="justify-content: flex-start; gap: 10px;">
                <input type="checkbox" [checked]="col.visible()" (change)="toggleColumn(col.id)"
                    (click)="$event.stopPropagation()">
                <span>{{ col.name }}</span>
            </div>
        </div>

        <div class="toolbar-dropdown" [class.visible]="isToolbarOpen" (click)="$event.stopPropagation()">
            <button class="dropdown-item" (click)="onAdd()">
                <span class="icon">+A</span>
                <span class="label">Add Activity</span>
            </button>
            <button class="dropdown-item" (click)="onAddWBS()">
                <span class="icon">+W</span>
                <span class="label">Add WBS</span>
            </button>
            <button class="dropdown-item" (click)="onDelete()">
                <span class="icon">×</span>
                <span class="label">Delete</span>
            </button>
            <div class="dropdown-divider"></div>
            <button class="dropdown-item" (click)="onSchedule()">
                <span class="icon">📅</span>
                <span class="label">Schedule</span>
            </button>
            <button class="dropdown-item" (click)="onBaseline($event)" title="Shift+Click to clear">
                <span class="icon">🎯</span>
                <span class="label">Baseline</span>
            </button>
            <button class="dropdown-item" (click)="onLevel($event)">
                <span class="icon">⚖️</span>
                <span class="label">Level Resources</span>
            </button>
        </div>
    </div>

    <!-- Editor Backdrop (Click outside to close) -->
    <div class="editor-backdrop" *ngIf="isEditorVisible" (click)="closeEditor()"></div>

    <!-- Editor Panel Container -->
    <div class="editor-panel-container" *ngIf="isEditorVisible">
        <app-editor (requestOpenProfile)="onOpenProfileRequest($event)"
            (requestOpenSCurves)="onOpenSCurvesRequest()"></app-editor>
    </div>

    <!-- EVM Dashboard (Hidden, moved to floating window) -->
    <!-- <div class="evm-section"><app-evm-dashboard></app-evm-dashboard></div> -->

    <!-- Floating Draggable Resource Profile / EVM Window -->
    <div class="floating-window printable-modal" *ngIf="isFloatingWindowVisible">

        <div class="window-header">
            <h3 style="margin: 0;" *ngIf="floatingWindowType === 'resource'">Usage Profile: {{
                floatingWindowResource?.name || 'Total Project' }}</h3>
            <h3 style="margin: 0;" *ngIf="floatingWindowType === 'evm'">Earned Value Management (EVM)</h3>
            <h3 style="margin: 0;" *ngIf="floatingWindowType === 's-curve'">S-Curves - EVM Trend Analysis</h3>

            <div class="window-controls" (mousedown)="$event.stopPropagation()">
                <div class="zoom-controls" *ngIf="floatingWindowType === 'resource'"
                    style="display: inline-flex; gap: 5px; margin-right: 15px;">
                    <button class="mini-btn" (click)="zoomResourceProfile(-0.1)" title="Zoom Out">-</button>
                    <button class="mini-btn" (click)="zoomResourceProfile(0.1)" title="Zoom In">+</button>
                </div>
                <button class="btn-print" (click)="printFloatingWindow()">🖨️ Print</button>
                <button class="close-btn" (click)="closeFloatingWindow()">×</button>
            </div>
        </div>

        <div class="window-content" (mousedown)="$event.stopPropagation()">
            <app-resource-usage-profile *ngIf="floatingWindowType === 'resource'" [projectState]="projectState()"
                [selectedResourceId]="floatingWindowResource?.id!" [startDate]="projectStartDate()"
                [endDate]="projectEndDate()" [dayWidth]="40" [zoomLevel]="resourceProfileZoomLevel" [scrollLeft]="0"
                style="flex: 1;">
            </app-resource-usage-profile>

            <app-evm-dashboard *ngIf="floatingWindowType === 'evm'"
                style="flex: 1; width: 100%; height: 100%; overflow: hidden;"></app-evm-dashboard>

            <app-s-curves-chart *ngIf="floatingWindowType === 's-curve'"
                style="flex: 1; width: 100%; height: 100%; overflow: hidden;"></app-s-curves-chart>
        </div>
    </div>

    <!-- Controls Area -->
    <!-- Main Split Chart -->
    <div class="gantt-body">
        <!-- Left Panel: Task List -->
        <!-- Left Panel: Grid -->
        <!-- Left Panel: Grid -->
        <!-- Left Panel: Grid -->
        <div class="task-list-panel" [style.width.px]="taskListWidth()">
            <div class="grid-header" [style.height.px]="headerHeight">
                <div class="grid-col" *ngFor="let col of visibleColumns()" [style.width.px]="col.width()">
                    {{ col.name }}
                    <div class="column-resize-handle" (mousedown)="onColumnResizeStart($event, col.id)"></div>
                </div>
            </div>
            <div class="task-list-rows" (scroll)="onTaskListScroll($event)" (click)="onDeselect($event)">
                <!-- ... existing rows ... -->
                <div class="task-row" *ngFor="let activity of visibleActivities()" [ngClass]="getWbsClass(activity)"
                    [style.background-color]="getPhaseColor(activity)" [class.root-project]="activity.id === 0"
                    [class.selected]="selectedActivity()?.id === activity.id"
                    [class.wbs-row]="isParentActivity(activity)" (click)="selectActivity(activity, $event)"
                    (dblclick)="onActivityDoubleClick(activity, $event)">

                    <div class="grid-col" *ngFor="let col of visibleColumns()" [style.width.px]="col.width()"
                        [ngSwitch]="col.id"
                        [style.padding-left.px]="col.id === 'name' ? (getActivityLevel(activity) * 20) : null"
                        [style.color]="(col.id === 'float' && (activity.totalFloat || 0) <= 0) ? 'red' : 'inherit'">

                        <!-- ID -->
                        <span *ngSwitchCase="'id'">{{ activity.id }}</span>

                        <!-- Status -->
                        <div *ngSwitchCase="'status'">
                            <span *ngIf="activity.percentComplete === 100">✓</span>
                            <span *ngIf="activity.isCritical && activity.percentComplete !== 100"
                                style="color: red;">!</span>
                        </div>

                        <!-- Name -->
                        <div *ngSwitchCase="'name'"
                            style="display: flex; align-items: center; width: 100%; overflow: hidden;">
                            <span class="expand-icon" *ngIf="isParentActivity(activity)"
                                (click)="toggleActivity(activity, $event)"
                                style="margin-right: 4px; cursor: pointer; font-family: monospace; font-weight: bold;">
                                {{ activity.isExpanded !== false ? "-" : "+" }}
                            </span>
                            <span [class.parent-activity]="isParentActivity(activity)"
                                style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                {{ activity.name }}
                            </span>
                        </div>

                        <!-- Duration -->
                        <span *ngSwitchCase="'dur'">{{ activity.duration }}</span>

                        <!-- Dates -->
                        <div *ngSwitchCase="'start'" style="width: 100%;">
                            <input type="date" [ngModel]="activity.startDate | date:'yyyy-MM-dd'"
                                (ngModelChange)="onStartDateChange(activity, $event)" class="grid-date-input">
                        </div>
                        <span *ngSwitchCase="'finish'">{{ getDisplayFinish(activity) | date:'dd-MMM-yy' }}</span>
                        <span *ngSwitchCase="'earlyStart'">{{ activity.earlyStart | date:'dd-MMM-yy' }}</span>
                        <span *ngSwitchCase="'earlyFinish'">{{ activity.earlyFinish | date:'dd-MMM-yy' }}</span>
                        <span *ngSwitchCase="'lateStart'">{{ activity.lateStart | date:'dd-MMM-yy' }}</span>
                        <span *ngSwitchCase="'lateFinish'">{{ activity.lateFinish | date:'dd-MMM-yy' }}</span>
                        <div *ngSwitchCase="'blStart'" style="width: 100%;">
                            <input type="date" [ngModel]="activity.baselineStartDate | date:'yyyy-MM-dd'"
                                (ngModelChange)="onBaselineStartChange(activity, $event)" class="grid-date-input"
                                placeholder="Not set">
                        </div>
                        <div *ngSwitchCase="'blFinish'" style="width: 100%;">
                            <input type="date" [ngModel]="activity.baselineEndDate | date:'yyyy-MM-dd'"
                                (ngModelChange)="onBaselineFinishChange(activity, $event)" class="grid-date-input"
                                placeholder="Not set">
                        </div>
                        <div *ngSwitchCase="'actualStart'" style="width: 100%;">
                            <input type="date" [ngModel]="activity.actualStart | date:'yyyy-MM-dd'"
                                (ngModelChange)="onActualStartChange(activity, $event)" class="grid-date-input"
                                placeholder="Not set">
                        </div>
                        <div *ngSwitchCase="'actualFinish'" style="width: 100%;">
                            <input type="date" [ngModel]="activity.actualFinish | date:'yyyy-MM-dd'"
                                (ngModelChange)="onActualFinishChange(activity, $event)" class="grid-date-input"
                                placeholder="Not set">
                        </div>

                        <!-- Numbers -->
                        <span *ngSwitchCase="'percent'">{{ activity.percentComplete }}%</span>
                        <span *ngSwitchCase="'float'">{{ activity.totalFloat || 0 }}</span>
                        <span *ngSwitchCase="'budget'">{{ activity.budgetAtCompletion | currency }}</span>
                        <span *ngSwitchCase="'actualCost'">{{ activity.actualCost | currency }}</span>

                    </div>
                </div>
            </div>
        </div>

        <!-- Draggable Splitter -->
        <div class="gutter-splitter" (mousedown)="onSplitterMouseDown($event)"></div>

        <!-- Right Panel: Timelne -->
        <div class="timeline-panel" (scroll)="onTimelineScroll($event)" (click)="onDeselect($event)">
            <!-- Timeline Scroller -->
            <div class="timeline-scroll-area" [style.width.px]="timelineWidth()">
                <!-- Scale Header -->
                <div class="timeline-scale">
                    <!-- Month/Year Row -->
                    <div class="month-row">
                        <div class="month-cell" *ngFor="let month of months()"
                            [style.width.px]="month.dayCount * dayWidth * zoomLevel()">
                            {{ month.date | date:'MMM yyyy' }}
                        </div>
                    </div>
                    <!-- Day Row -->
                    <div class="day-row">
                        <div class="scale-cell" *ngFor="let day of days()" [style.width.px]="dayWidth * zoomLevel()">
                            {{ day | date:'d' }}
                        </div>
                    </div>
                </div>

                <!-- Timeline Grid/Rows -->
                <div class="timeline-grid" [style.height.px]="visibleActivities().length * rowHeight">
                    <!-- Background Grid Lines -->
                    <div class="grid-background" [style.height.px]="visibleActivities().length * rowHeight">
                        <div class="grid-col" *ngFor="let day of days()" [style.width.px]="dayWidth * zoomLevel()">
                        </div>
                    </div>

                    <!-- Task Bars -->
                    <div class="task-bars-container" [style.height.px]="visibleActivities().length * rowHeight">
                        <!-- Dependency Lines SVG -->
                        <svg class="dependency-lines-container"
                            [style.height.px]="visibleActivities().length * rowHeight"
                            [style.width.px]="timelineWidth()">
                            <!-- Arrow Markers -->
                            <defs>
                                <!-- Start Circle Markers -->
                                <marker id="circleFS" markerWidth="6" markerHeight="6" refX="3" refY="3"
                                    markerUnits="userSpaceOnUse">
                                    <circle cx="3" cy="3" r="3" fill="#fc00fcff" />
                                </marker>
                                <marker id="circleFF" markerWidth="6" markerHeight="6" refX="3" refY="3"
                                    markerUnits="userSpaceOnUse">
                                    <circle cx="3" cy="3" r="3" fill="#01daf7ff" />
                                </marker>
                                <marker id="circleSS" markerWidth="6" markerHeight="6" refX="3" refY="3"
                                    markerUnits="userSpaceOnUse">
                                    <circle cx="3" cy="3" r="3" fill="#ff6b6b" />
                                </marker>
                                <marker id="circleSF" markerWidth="6" markerHeight="6" refX="3" refY="3"
                                    markerUnits="userSpaceOnUse">
                                    <circle cx="3" cy="3" r="3" fill="#fcc419" />
                                </marker>

                                <!-- End Arrow Markers -->
                                <marker id="arrowFS" markerWidth="15" markerHeight="10" refX="0" refY="4" leading="auto"
                                    markerUnits="userSpaceOnUse">
                                    <path d="M0,0 L0,8 L14,4 z" fill="#fc00fcff" />
                                </marker>
                                <marker id="arrowFF" markerWidth="15" markerHeight="10" refX="0" refY="4" orient="auto"
                                    markerUnits="userSpaceOnUse">
                                    <path d="M0,0 L0,8 L14,4 z" fill="#01daf7ff" />
                                </marker>
                                <marker id="arrowSS" markerWidth="15" markerHeight="10" refX="0" refY="4" orient="auto"
                                    markerUnits="userSpaceOnUse">
                                    <path d="M0,0 L0,8 L14,4 z" fill="#ff6b6b" />
                                </marker>
                                <marker id="arrowSF" markerWidth="15" markerHeight="10" refX="0" refY="4" orient="auto"
                                    markerUnits="userSpaceOnUse">
                                    <path d="M0,0 L0,8 L14,4 z" fill="#fcc419" />
                                </marker>
                            </defs>
                            <!-- Existing Links -->
                            <path *ngFor="let link of dependencyLines()" [attr.d]="link.path" [attr.stroke]="link.color"
                                [attr.marker-start]="'url(#circle' + link.type + ')'"
                                [attr.marker-end]="'url(#arrow' + link.type + ')'" fill="none" class="link-path"
                                [class.selected]="selectedDependency()?.id === link.id"
                                (click)="onLinkClick(link.id, $event)" (dblclick)="onLinkDoubleClick(link.id, $event)"
                                [attr.data-link-id]="link.id" [attr.title]="link.type" />

                            <!-- Creating Link (Temp Line) -->
                            <line *ngIf="isLinking && tempLinkEnd" [attr.x1]="tempLinkStart.x"
                                [attr.y1]="tempLinkStart.y" [attr.x2]="tempLinkEnd.x" [attr.y2]="tempLinkEnd.y"
                                class="link-drag-line" style="pointer-events: none;" />
                        </svg>

                        <div class="task-bar-wrapper" *ngFor="let activity of visibleActivities(); let i = index"
                            [style.top.px]="i * rowHeight" [style.height.px]="rowHeight">

                            <!-- Baseline Bar -->
                            <div class="baseline-bar" *ngIf="activity.baselineStartDate"
                                [style.left.px]="getBaselineLeft(activity.baselineStartDate)"
                                [style.width.px]="getBaselineWidth(activity.baselineStartDate, activity.baselineEndDate)">
                            </div>

                            <!-- Baseline Milestone Diamond -->
                            <div class="baseline-milestone-diamond"
                                *ngIf="(activity.type === 'StartMilestone' || activity.type === 'FinishMilestone') && activity.baselineStartDate"
                                [style.left.px]="getBaselineLeft(activity.baselineStartDate)" [style.top.px]="18">
                            </div>

                            <!-- Milestone Diamond -->
                            <div class="milestone-diamond"
                                *ngIf="activity.type === 'StartMilestone' || activity.type === 'FinishMilestone'"
                                [class.selected]="selectedActivity()?.id === activity.id"
                                [class.critical]="activity.isCritical" (mousedown)="onTaskMouseDown($event, activity)"
                                (click)="selectActivity(activity, $event)" [style.left.px]="getTaskLeft(activity)"
                                [style.top.px]="5">
                                <span class="task-label">{{ activity.name }}</span>
                            </div>

                            <!-- Regular Task Bar -->
                            <div class="task-bar"
                                *ngIf="!activity.type || activity.type === 'Task' || activity.type === 'WBS'"
                                [class.parent-task-bar]="isParentActivity(activity)"
                                [class.zoom-large]="zoomLevel() > .5"
                                [class.selected]="selectedActivity()?.id === activity.id"
                                [class.critical]="activity.isCritical" (mousedown)="onTaskMouseDown($event, activity)"
                                (click)="selectActivity(activity, $event)"
                                (dblclick)="onActivityDoubleClick(activity, $event)"
                                [style.left.px]="getTaskLeft(activity)" [style.width.px]="getTaskWidth(activity)">

                                <!-- Resize Handles -->
                                <div class="resize-handle resize-left"
                                    (mousedown)="onResizeMouseDown($event, activity, 'left')"></div>
                                <div class="resize-handle resize-right"
                                    (mousedown)="onResizeMouseDown($event, activity, 'right')"></div>

                                <!-- Link Handles -->
                                <div class="link-handle handle-left" [attr.data-id]="activity.id" data-type="start"
                                    (mousedown)="onHandleMouseDown($event, activity, 'start')"></div>
                                <div class="link-handle handle-right" [attr.data-id]="activity.id" data-type="finish"
                                    (mousedown)="onHandleMouseDown($event, activity, 'finish')"></div>

                                <div class="progress" [style.width.%]="activity.percentComplete"></div>
                                <span class="task-label">{{ activity.name }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Activity Modal -->
    <div class="modal-overlay" *ngIf="editingActivity" (click)="cancelEdit()">
        <div class="modal-content" (click)="$event.stopPropagation()">
            <h3>Edit Activity</h3>
            <form (submit)="saveEdit(); $event.preventDefault()">
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" [(ngModel)]="editForm.name" name="name" required>
                </div>
                <div class="form-group">
                    <label>Start Date</label>
                    <input type="date" [(ngModel)]="editForm.startDate" name="startDate" required>
                </div>
                <div class="form-group">
                    <label>Duration (days)</label>
                    <input type="number" [(ngModel)]="editForm.duration" name="duration" min="1" required>
                </div>
                <div class="form-group">
                    <label>Progress (%)</label>
                    <input type="number" [(ngModel)]="editForm.percentComplete" name="percentComplete" min="0" max="100"
                        required>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" (click)="cancelEdit()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>

    <div class="bottom-panel"
        *ngIf="(isActivityDetailsVisible() && selectedActivity()) || (isDependencyDetailsVisible() && selectedDependency())">
        <div class="bottom-panel-content">
            <app-activity-details *ngIf="isActivityDetailsVisible() && selectedActivity()"
                (close)="closeActivityDetails()"></app-activity-details>
            <app-dependency-details *ngIf="isDependencyDetailsVisible() && selectedDependency()"
                (close)="closeDependencyDetails()"></app-dependency-details>
        </div>
    </div>

    <!-- Book Icon -->
    <div class="floating-book-icon" (click)="onBookIconClick()">
        <!-- Book SVG -->
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
            <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
        </svg>
    </div>

    <!-- Side Window REMOVED -->
</div>
```