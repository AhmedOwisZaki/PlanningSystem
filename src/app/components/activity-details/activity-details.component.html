<div class="details-panel" *ngIf="selectedActivity()" [style.height.px]="detailsPanelHeight()">
    <div class="resize-handle" (mousedown)="onPanelResizeStart($event)"></div>
    <div class="details-header">
        <h3>Activity Details</h3>
        <button class="close-btn" (click)="closeDetailsPanel()">×</button>
    </div>

    <div class="details-tabs">
        <button [class.active]="activeTab() === 'general'" (click)="setActiveTab('general')">General</button>
        <button [class.active]="activeTab() === 'resources'" (click)="setActiveTab('resources')">Resources</button>
        <button [class.active]="activeTab() === 'relationships'"
            (click)="setActiveTab('relationships')">Relationships</button>
        <button [class.active]="activeTab() === 'steps'" (click)="setActiveTab('steps')">Steps</button>
        <button [class.active]="activeTab() === 'cost'" (click)="setActiveTab('cost')">Cost</button>
        <button [class.active]="activeTab() === 'codes'" (click)="setActiveTab('codes')">Codes</button>
    </div>

    <div class="details-content" *ngIf="activeTab() === 'general'">
        <div class="detail-item">
            <label>Name:</label>
            <input type="text" [value]="selectedActivity()!.name" (change)="onNameChange($event)" class="form-control">
        </div>
        <div class="detail-item">
            <label>Type:</label>
            <select [value]="selectedActivity()!.type || 'Task'" (change)="onTypeChange($event)">
                <option value="Task">Task Based</option>
                <option value="WBS">WBS Summary</option>
                <option value="StartMilestone">Start Milestone</option>
                <option value="FinishMilestone">Finish Milestone</option>
            </select>
        </div>
        <div class="detail-item">
            <label>Calendar:</label>
            <select [value]="selectedActivity()!.calendarId" (change)="onCalendarChange($event)">
                <option *ngFor="let cal of calendars()" [value]="cal.id">
                    {{ cal.name }} {{ cal.isDefault ? '(Default)' : '' }}
                </option>
            </select>
        </div>
        <div class="detail-item">
            <label>Start Date:</label>
            <span>{{ selectedActivity()!.startDate | date:'mediumDate' }}</span>
        </div>
        <div class="detail-item">
            <label>Duration:</label>
            <input type="number" [value]="selectedActivity()!.duration" (change)="onDurationChange($event)" min="1"
                class="form-control" style="width: 80px;">
            <span style="margin-left: 5px;">days</span>
        </div>
        <div class="detail-item">
            <label>End Date:</label>
            <span>{{ getEndDate(selectedActivity()!) | date:'mediumDate' }}</span>
        </div>
        <div class="detail-item">
            <label>Actual Start:</label>
            <input type="date" [ngModel]="selectedActivity()!.actualStart | date:'yyyy-MM-dd'"
                (ngModelChange)="onActualStartChange($event)" class="form-control" placeholder="Not set">
        </div>
        <div class="detail-item">
            <label>Actual Finish:</label>
            <input type="date" [ngModel]="selectedActivity()!.actualFinish | date:'yyyy-MM-dd'"
                (ngModelChange)="onActualFinishChange($event)" class="form-control" placeholder="Not set">
        </div>
        <div class="detail-item">
            <label>Baseline Start:</label>
            <input type="date" [ngModel]="selectedActivity()!.baselineStartDate | date:'yyyy-MM-dd'"
                (ngModelChange)="onBaselineStartChange($event)" class="form-control" placeholder="Not set">
        </div>
        <div class="detail-item">
            <label>Baseline Finish:</label>
            <input type="date" [ngModel]="selectedActivity()!.baselineEndDate | date:'yyyy-MM-dd'"
                (ngModelChange)="onBaselineFinishChange($event)" class="form-control" placeholder="Not set">
        </div>
        <div class="detail-item">
            <label>Variance:</label>
            <span [style.color]="getVariance(selectedActivity()!) > 0 ? 'red' : 'green'">
                {{ getVariance(selectedActivity()!) }} days
            </span>
        </div>
        <div class="detail-item">
            <label>Progress:</label>
            <span>{{ selectedActivity()!.percentComplete }}%</span>
        </div>
        <div class="detail-item">
            <label>ID:</label>
            <span>{{ selectedActivity()!.id }}</span>
        </div>
    </div>

    <div class="details-content resources-content" *ngIf="activeTab() === 'resources'">
        <div class="resources-split-layout">
            <!-- Left Side: Allocated Resources List -->
            <div class="resources-list-section">
                <div *ngIf="selectedActivity()?.resourceItems?.length; else noResources">
                    <table class="resource-table">
                        <thead>
                            <tr>
                                <th>Resource</th>
                                <th>Cost</th>
                                <th>Qty</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let item of selectedActivity()?.resourceItems"
                                (dblclick)="startEditResourceItem(item)">
                                <td>{{ getResourceName(item.resourceId) }}</td>
                                <td>{{ getResourceCost(item.resourceId) | currency }}</td>
                                <td>
                                    <div *ngIf="editingResourceItemId() !== item.id">
                                        {{ item.amount }}
                                    </div>
                                    <div *ngIf="editingResourceItemId() === item.id" (click)="$event.stopPropagation()">
                                        <input type="number" [(ngModel)]="editAmount"
                                            (keyup.enter)="saveResourceItemEdit()"
                                            (keyup.esc)="cancelResourceItemEdit()" (blur)="saveResourceItemEdit()"
                                            class="form-control" style="width: 70px; padding: 2px 5px;"
                                            [autofocus]="true">
                                    </div>
                                </td>
                                <td>{{ item.amount * getResourceCost(item.resourceId) | currency }}</td>
                                <td>
                                    <button class="close-btn" style="font-size:1.2rem; width:20px; height:20px;"
                                        (click)="deleteResourceItem(item)">×</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <ng-template #noResources>
                    <div class="no-resources" *ngIf="!isAssigningResource">
                        <i class="icon-info"></i> No resources assigned.
                    </div>
                </ng-template>
            </div>

            <!-- Right Side: Assignment Controls -->
            <div class="resources-assign-section">
                <div class="assign-controls">
                    <!-- Always show header or title -->
                    <h4 class="assign-header">Assign Resource</h4>

                    <button class="btn-assign" *ngIf="!isAssigningResource" (click)="startAssignResource()">+
                        Add</button>

                    <div class="assign-form" *ngIf="isAssigningResource">
                        <div class="form-group">
                            <label>Resource</label>
                            <select [(ngModel)]="newAssignment.resourceId" class="form-control">
                                <option [ngValue]="null" disabled>Select...</option>
                                <option *ngFor="let res of resources()" [ngValue]="res.id">
                                    {{ res.name }}
                                </option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Amount</label>
                            <input type="number" [(ngModel)]="newAssignment.amount" min="1" class="form-control"
                                placeholder="1">
                        </div>
                        <div class="form-actions">
                            <button class="btn-cancel" (click)="cancelAssignResource()">Cancel</button>
                            <button class="btn-save" (click)="saveResourceAssignment()"
                                [disabled]="!newAssignment.resourceId">Save</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="details-content relationships-content" *ngIf="activeTab() === 'relationships'">
        <div class="relationship-column">
            <h4>Predecessors</h4>
            <table class="resource-table">
                <thead>
                    <tr>
                        <th>Activity</th>
                        <th>Type</th>
                        <th>Lag</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let dep of predecessors()">
                        <td>{{ getActivityName(dep.sourceId) }}</td>
                        <td>{{ dep.type }}</td>
                        <td>
                            <input type="number" [value]="dep.lag || 0" (change)="updateLag(dep.id, $event)"
                                class="lag-input" style="width: 50px;">
                        </td>
                        <td>
                            <button class="close-btn" style="font-size:1.2rem; width:20px; height:20px;"
                                (click)="deleteDependency(dep.id)">×</button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="relationship-column">
            <h4>Successors</h4>
            <table class="resource-table">
                <thead>
                    <tr>
                        <th>Activity</th>
                        <th>Type</th>
                        <th>Lag</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let dep of successors()">
                        <td>{{ getActivityName(dep.targetId) }}</td>
                        <th>{{ dep.type }}</th>
                        <td>
                            <input type="number" [value]="dep.lag || 0" (change)="updateLag(dep.id, $event)"
                                class="lag-input" style="width: 50px;">
                        </td>
                        <td>
                            <button class="close-btn" style="font-size:1.2rem; width:20px; height:20px;"
                                (click)="deleteDependency(dep.id)">×</button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Steps Tab Content -->
    <div class="details-content steps-content" *ngIf="activeTab() === 'steps'">
        <div class="detail-item full-width" style="margin-bottom: 15px;">
            <label>Percent Complete Type:</label>
            <select [value]="selectedActivity()!.earningType || 'Duration'" (change)="onEarningTypeChange($event)">
                <option value="Duration">Duration</option>
                <option value="Physical">Physical</option>
                <option value="Steps">Activity Steps</option>
            </select>
            <small class="hint" *ngIf="selectedActivity()!.earningType === 'Steps'"
                style="display:block; margin-top:5px; color:#666;">
                % Complete is calculated automatically from step weights.
            </small>
        </div>

        <div class="steps-list-section">
            <table class="resource-table">
                <thead>
                    <tr>
                        <th style="width: 40px;">Done</th>
                        <th>Step Name</th>
                        <th style="width: 60px;">Weight</th>
                        <th style="width: 40px;"></th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let step of selectedActivity()?.steps || []">
                        <td style="text-align: center;">
                            <input type="checkbox" [checked]="step.completed" (change)="toggleStep(step.id)">
                        </td>
                        <td>{{ step.name }}</td>
                        <td>{{ step.weight }}</td>
                        <td>
                            <button class="close-btn" style="font-size:1.2rem; width:20px; height:20px;"
                                (click)="removeStep(step.id)">×</button>
                        </td>
                    </tr>
                </tbody>
            </table>
            <div class="no-resources" *ngIf="(!selectedActivity()?.steps || selectedActivity()!.steps!.length === 0)">
                No steps defined.
            </div>
        </div>

        <div class="add-step-form" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee;">
            <h4>Add Activity Step</h4>
            <div style="display: flex; gap: 10px; align-items: center;">
                <input type="text" [(ngModel)]="newStepName" placeholder="Step Name" class="form-control"
                    style="flex: 2;">
                <input type="number" [(ngModel)]="newStepWeight" placeholder="Weight" class="form-control" min="1"
                    style="flex: 1;">
                <button class="btn-assign" (click)="addStep()" [disabled]="!newStepName.trim()">Add</button>
            </div>
        </div>
    </div>

    <!-- Codes Tab Content -->
    <div class="details-content codes-content" *ngIf="activeTab() === 'codes'">
        <div class="codes-grid">
            <div class="code-item" *ngFor="let def of codeDefinitions()">
                <label>{{ def.name }}</label>
                <select [value]="getAssignedValue(def.id)" (change)="onCodeChange(def.id, $event)">
                    <option value="null">-- None --</option>
                    <option *ngFor="let val of def.values" [value]="val.id">
                        {{ val.value }}
                    </option>
                </select>
                <!-- Show color preview if selected -->
                <span class="color-preview" *ngIf="getAssignedValue(def.id) !== 'null'"
                    [style.background-color]="getCodeColor(def.id)">
                </span>
            </div>
            <div *ngIf="codeDefinitions().length === 0" class="no-data">
                No activity codes defined. Go to Project Editor > Codes to define them.
            </div>
        </div>
    </div>
</div>